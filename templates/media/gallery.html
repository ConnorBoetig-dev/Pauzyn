{% extends "base.html" %}

{% block styles %}
<style>
.gallery-container {
    padding: 2rem;
    max-width: 1200px;
    margin: 0 auto;
}

.gallery-controls {
    margin-bottom: 2rem;
    display: flex;
    gap: 1rem;
}

.gallery-controls select {
    padding: 0.5rem;
    border-radius: 4px;
    border: 1px solid #ddd;
}

.gallery-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(250px, 1fr));
    gap: 1.5rem;
    padding: 1rem;
}

.gallery-item {
    background: white;
    border-radius: 8px;
    box-shadow: 0 2px 4px rgba(0,0,0,0.1);
    overflow: hidden;
    transition: transform 0.2s;
}

.gallery-item:hover {
    transform: translateY(-2px);
    box-shadow: 0 4px 8px rgba(0,0,0,0.15);
}

.image-container, .video-container {
    aspect-ratio: 1;
    overflow: hidden;
}

.image-container img, .video-container video {
    width: 100%;
    height: 100%;
    object-fit: cover;
}

.item-info {
    padding: 0.75rem;
    text-align: center;
}

.filename {
    font-size: 0.9rem;
    color: #333;
    overflow: hidden;
    text-overflow: ellipsis;
    white-space: nowrap;
}

.load-more {
    text-align: center;
    margin: 2rem 0;
}

.load-more button {
    padding: 0.75rem 2rem;
    border-radius: 4px;
    border: none;
    background: #007bff;
    color: white;
    cursor: pointer;
    transition: background 0.2s;
}

.load-more button:hover {
    background: #0056b3;
}

.modal-counter {
    color: white;
    position: absolute;
    top: 20px;
    left: 20px;
}
</style>
{% endblock %}

{% block content %}
<div class="gallery-container">
    <div class="gallery-controls">
        <select id="mediaTypeFilter">
            <option value="all">All</option>
            <option value="image">Images</option>
            <option value="video">Videos</option>
        </select>
        
        <select id="sortOrder">
            <option value="date">Sort by Date</option>
            <option value="name">Sort by Name</option>
        </select>
    </div>

    <div id="gallery-grid" class="gallery-grid">
        {% for item in initial_items %}
        <div class="gallery-item" data-id="{{ item.id }}" data-type="{{ item.type }}" data-url="{{ item.url }}" data-filename="{{ item.filename }}">
            {% if item.type == 'image' %}
            <div class="image-container">
                <img src="{{ item.url }}" alt="{{ item.filename }}">
            </div>
            {% else %}
            <div class="video-container">
                <video src="{{ item.url }}" controls></video>
            </div>
            {% endif %}
            <div class="item-info">
                <span class="filename">{{ item.filename }}</span>
            </div>
        </div>
        {% endfor %}
    </div>

    {% if has_more %}
    <div id="load-more" class="load-more">
        <button onclick="loadMore()">Load More</button>
    </div>
    {% endif %}
</div>

<!-- Lightbox Modal -->
<div id="mediaModal" class="media-modal">
    <span class="modal-close">&times;</span>
    <div class="modal-content">
        <span class="modal-counter">1 / 1</span>
        <div class="modal-media-container">
            <!-- Media will be inserted here -->
        </div>
        <div class="modal-nav">
            <span class="modal-prev">&#10094;</span>
            <span class="modal-next">&#10095;</span>
        </div>
        <div class="modal-info">
            <!-- Filename and other info will go here -->
        </div>
    </div>
</div>

<script>
// Add JavaScript for handling filters and pagination
document.getElementById('mediaTypeFilter').addEventListener('change', refreshGallery);
document.getElementById('sortOrder').addEventListener('change', refreshGallery);

function refreshGallery() {
    const mediaType = document.getElementById('mediaTypeFilter').value;
    const sortBy = document.getElementById('sortOrder').value;
    
    fetch(`/api/media/list?type=${mediaType}&sort=${sortBy}`)
        .then(response => response.json())
        .then(data => {
            const gallery = document.getElementById('gallery-grid');
            gallery.innerHTML = ''; // Clear existing items
            
            data.items.forEach(item => {
                const itemElement = createGalleryItem(item);
                gallery.appendChild(itemElement);
            });
        })
        .catch(error => console.error('Error refreshing gallery:', error));
}

function createGalleryItem(item) {
    const div = document.createElement('div');
    div.className = 'gallery-item';
    div.dataset.id = item.id;
    
    if (item.type === 'image') {
        div.innerHTML = `
            <div class="image-container">
                <img src="${item.url}" alt="${item.filename}">
            </div>
            <div class="item-info">
                <span class="filename">${item.filename}</span>
            </div>
        `;
    } else {
        div.innerHTML = `
            <div class="video-container">
                <video src="${item.url}" controls></video>
            </div>
            <div class="item-info">
                <span class="filename">${item.filename}</span>
            </div>
        `;
    }
    
    return div;
}

document.addEventListener('DOMContentLoaded', function() {
    attachItemClickListeners();
    new GalleryManager();
});
</script>
{% endblock %}

{% block scripts %}
<script src="{{ url_for('static', filename='js/gallery.js') }}"></script>
<script>
let lastEvaluatedKey = null;

function loadMore() {
    const mediaType = document.getElementById('mediaTypeFilter').value;
    const sortBy = document.getElementById('sortOrder').value;
    
    if (!lastEvaluatedKey) {
        console.error("No last evaluated key available");
        return;
    }
    
    // Encode the lastEvaluatedKey for URL
    const encodedKey = encodeURIComponent(JSON.stringify(lastEvaluatedKey));
    
    fetch(`/api/media/list?type=${mediaType}&sort=${sortBy}&lastKey=${encodedKey}`)
        .then(response => response.json())
        .then(data => {
            const gallery = document.getElementById('gallery-grid');
            
            // Append new items
            data.items.forEach(item => {
                const itemElement = createGalleryItem(item);
                gallery.appendChild(itemElement);
            });
            
            // Update last key for next pagination
            lastEvaluatedKey = data.lastKey ? JSON.parse(data.lastKey) : null;
            
            // Hide "Load More" button if no more items
            if (!data.hasMore) {
                document.getElementById('load-more').style.display = 'none';
            }
            
            // Reattach event listeners for new items
            attachItemClickListeners();
        })
        .catch(error => console.error('Error loading more items:', error));
}

function refreshGallery() {
    const mediaType = document.getElementById('mediaTypeFilter').value;
    const sortBy = document.getElementById('sortOrder').value;
    
    fetch(`/api/media/list?type=${mediaType}&sort=${sortBy}`)
        .then(response => response.json())
        .then(data => {
            const gallery = document.getElementById('gallery-grid');
            gallery.innerHTML = ''; // Clear existing items
            
            data.items.forEach(item => {
                const itemElement = createGalleryItem(item);
                gallery.appendChild(itemElement);
            });
            
            // Update pagination state
            lastEvaluatedKey = data.lastKey ? JSON.parse(data.lastKey) : null;
            
            // Show/hide "Load More" button
            const loadMoreBtn = document.getElementById('load-more');
            if (loadMoreBtn) {
                loadMoreBtn.style.display = data.hasMore ? 'block' : 'none';
            }
            
            // Reattach event listeners
            attachItemClickListeners();
        })
        .catch(error => console.error('Error refreshing gallery:', error));
}

// Initialize lastEvaluatedKey from server-side data
document.addEventListener('DOMContentLoaded', function() {
    // Get initial lastKey from the server-rendered data
    const initialData = {{ initial_data|tojson|safe if initial_data else 'null' }};
    if (initialData && initialData.lastKey) {
        lastEvaluatedKey = JSON.parse(initialData.lastKey);
    }
    
    attachItemClickListeners();
    new GalleryManager();
});

class GalleryManager {
    constructor() {
        this.mediaFiles = [];
        this.swiper = null;
        this.modal = new bootstrap.Modal(document.getElementById('mediaModal'));
        this.setupEventListeners();
        this.loadMedia();
    }

    setupEventListeners() {
        document.getElementById('filterType').addEventListener('change', () => this.loadMedia());
        document.getElementById('sortBy').addEventListener('change', () => this.loadMedia());
    }

    async loadMedia() {
        const filterType = document.getElementById('filterType').value;
        const sortBy = document.getElementById('sortBy').value;
        
        try {
            const response = await fetch(`/api/media/list?type=${filterType}&sort=${sortBy}`);
            this.mediaFiles = await response.json();
            this.renderGallery();
        } catch (error) {
            console.error('Error loading media:', error);
        }
    }

    renderGallery() {
        const grid = document.getElementById('galleryGrid');
        grid.innerHTML = '';
        
        this.mediaFiles.forEach((file, index) => {
            const item = document.createElement('div');
            item.className = 'gallery-item';
            
            if (file.type === 'image') {
                item.innerHTML = `<img src="${file.url}" alt="${file.filename}">`;
            } else if (file.type === 'video') {
                item.innerHTML = `<video src="${file.url}"></video>`;
            }
            
            item.addEventListener('click', () => this.openModal(index));
            grid.appendChild(item);
        });
    }

    openModal(index) {
        const swiperWrapper = document.querySelector('.swiper-wrapper');
        swiperWrapper.innerHTML = '';
        
        this.mediaFiles.forEach(file => {
            const slide = document.createElement('div');
            slide.className = 'swiper-slide';
            
            let mediaElement;
            if (file.type === 'image') {
                mediaElement = `<img src="${file.url}" alt="${file.filename}">`;
            } else if (file.type === 'video') {
                mediaElement = `<video src="${file.url}" controls></video>`;
            }
            
            slide.innerHTML = `
                ${mediaElement}
                <div class="media-info">
                    <h5>${file.filename}</h5>
                    <p>Uploaded: ${new Date(file.lastModified).toLocaleDateString()}</p>
                    <p>Size: ${(file.size / 1024 / 1024).toFixed(2)} MB</p>
                </div>
            `;
            swiperWrapper.appendChild(slide);
        });
        
        if (!this.swiper) {
            this.swiper = new Swiper('.swiper', {
                navigation: {
                    nextEl: '.swiper-button-next',
                    prevEl: '.swiper-button-prev',
                },
                pagination: {
                    el: '.swiper-pagination',
                    type: 'fraction',
                },
            });
        } else {
            this.swiper.update();
        }
        
        this.swiper.slideTo(index, 0);
        this.modal.show();
    }
}

document.addEventListener('DOMContentLoaded', () => {
    new GalleryManager();
});
</script>
{% endblock %}






